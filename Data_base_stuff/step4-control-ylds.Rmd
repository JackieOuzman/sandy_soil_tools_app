---
title: "Control yields"
author: "Jackie Ouzman"
date: "10/02/2022"
output: html_document
---

```{r setup, include=FALSE}

library(ggplot2)
library(readxl)
library(tidyverse)
#library(multcompView)

library(plotly)

library(tidyverse)
library(hrbrthemes)
library(viridis)
library(forcats)
library(hrbrthemes)
library(stringr)
#install.packages("hrbrthemes")

library(ggpubr)


```

## Control yields






Note everything runs off of the rep specified in the raw data.
I have run into problems with Younghusband, because the rep are not like the other sites.
For the control the raw data has 4 yield results that are labelled rep 1.

This means that the ID (which is supposed to unique is not)

I have created a new rep which is the clm called bay number and the rep to create a rep_block
so for the control I have how have 
rep block called
Bay 1 rep 1
Bay 1 rep 2
....


```{r Get the data, include=FALSE}
#################################################################################################################
####   Get the data #####



#####################################################################################################################

data_file <- "X:/Therese_Jackie/Sandy_soils/Development_database/other_sites_working/stats_working/sites_merged.csv"
data_file_control <- "X:/Therese_Jackie/Sandy_soils/Development_database/other_sites_working/stats_working/sites_control_merged.csv"

## download the data using the specified file path above

summary_data_all <- read_csv(data_file, 
                             col_types = cols(rep_block = col_character()))
summary_control_data_all <- read_csv(data_file_control, 
                            col_types = cols(rep_block = col_character()))



### make a dummy clm to filter out Younghusband 2021 data
summary_data_all <- summary_data_all %>%
  dplyr::mutate(site_yr_dummy = paste0(site, year))

## filter out the 2021 Younghusband data
summary_data_all <- summary_data_all %>%
  filter(site_yr_dummy  != "Younghusband2021") 



### make a dummy clm to filter out Younghusband 2021 data
summary_control_data_all <- summary_control_data_all %>%
  dplyr::mutate(site_yr_dummy = paste0(site, year))

## filter out the 2021 Younghusband data
summary_control_data_all <- summary_control_data_all %>%
  filter(site_yr_dummy  != "Younghusband2021") 



unique(summary_control_data_all$site_sub)
unique(summary_control_data_all$site)

str(summary_control_data_all)



##label problem with Mt Damper
summary_control_data_all <- summary_control_data_all %>% 
  mutate(
    site_sub = case_when(
      site_sub == "Mt Damper" ~ "Mt_Damper",
      TRUE ~ site_sub))

##label problem with Ouyen
summary_control_data_all <- summary_control_data_all %>% 
  mutate(
    site_sub = case_when(
      site_sub == "Oyen_Spade" ~ "Ouyen_Spade",
      TRUE ~ site_sub))
summary_control_data_all <- summary_control_data_all %>% 
  mutate(
    site = case_when(
      site == "Oyen_Spade" ~ "Ouyen_Spade",
      TRUE ~ site))


## list of sites that are ready ish

list_sites_ready <- c("Brimpton Lake",
                      "Brooker",
                      "Buckleboo",
                      "Bute_CSIRO",
                      "Bute_Trengrove",
                      "Cadgee",
                      "Carwarp_Amelioration",
                      "Cummins",
                      "Karkoo",
                      "Karoonda",
                      "Kooloonong_canola",
                      "Kooloonong_chickpea",
                      "Kooloonong_lentil",
                      "Kooloonong_lupin",
                      "Kybunga",#newly added
                      "Lowaldie_Crest",
                      "Lowaldie_Deep sand",
                      "Malinong", #newly added
                      "Monia_Gap", #newly added
                      "Mt Damper",
                      "Mt_Damper",
                      "Murlong",
                      "Oyen_Spade",
                      "Ouyen_Spade",
                      "Sherwood",
                      "Telopea_Downs",
                      "Tempy",
                      "Waikerie",
                      "Warnertown", #newly added
                      "Wynarka",
                      "Yenda",
                      "Younghusband"
                      )




summary_control_data_all <- summary_control_data_all %>% 
  filter(site_sub %in% list_sites_ready  )
summary_data_all <- summary_data_all %>% 
  filter(site_sub %in% list_sites_ready  )





# write.csv(summary_control_data_all, 
# "X:/Therese_Jackie/Sandy_soils/Development_database/other_sites_working/stats_working/sites_merged_CONTROL_incomplete.csv",
# row.names = FALSE)
# 
# write.csv(summary_data_all, 
# "X:/Therese_Jackie/Sandy_soils/Development_database/other_sites_working/stats_working/sites_merged_incomplete.csv",
# row.names = FALSE)

```

How many sites?

```{r how many sites all, echo=FALSE, message=FALSE, warning=FALSE}
#How many site?

sites <- summary_data_all %>% 
  distinct(site) 
sites %>% 
  count()
```


How many descriptors?

```{r how many desciptors all, echo=FALSE, message=FALSE, warning=FALSE}
## how many desciptors?

#names(summary_data_all)
desciptors <- summary_data_all %>% 
  distinct(Descriptors) 
desciptors %>% 
count()

```


How many soil modification (including different depths)?
  
```{r working out how many modification all 1, message=FALSE, warning=FALSE, include=FALSE}
#####################################################################################
#####  soil modifications      #####
#####################################################################################

### get the soil modification from the Descriptors

#1 soil modification with depth
summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_depth =  str_extract(summary_control_data_all$Descriptors, "[^_]+"))#keep everything before the first_


#1.1 Youndhusband has 'Unmodified+DeepTill.18' which needs to be recoded as "Unmodified"

summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_depth = case_when(
         soil_modification_depth == "Unmodified+DeepTill.18" ~ "Unmodified",
         TRUE ~ soil_modification_depth))

#how many modification_depth
soil_modification_depth <- summary_control_data_all %>% 
  distinct(soil_modification_depth) %>% 
  arrange(soil_modification_depth) %>% 
  filter(soil_modification_depth != "Unmodified")

count(soil_modification_depth) #20 excluding the unmodified


#1a working clms - soil modification without depth 1 only
summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_1 =  str_extract(summary_control_data_all$Descriptors, "[^.]+"))#keep everything before the first .

#the Unmodified seems to have a problem this fixes it :)
summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_1 = str_extract(summary_control_data_all$soil_modification_1, "[^_]+")) #keep everything after the first _

#1a.1 Youndhusband has 'Unmodified+DeepTill.18' which needs to be recoded as "Unmodified"

summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_1 = case_when(
    soil_modification_1 == "Unmodified+DeepTill" ~ "Unmodified",
    TRUE ~ soil_modification_1))

summary_control_data_all %>%  distinct(soil_modification_1) %>% arrange(soil_modification_1)





#1a working clms - 2 soil modification without depth 2

#temp <- summary_control_data_all %>%  distinct(soil_modification_depth) %>% arrange(soil_modification_depth)

summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification_2 = case_when(
    soil_modification_depth == "Rip.50Spade.30" ~        "Rip+Spade",
    soil_modification_depth == "Rip.60Spade.30" ~        "Rip+Spade",
    soil_modification_depth == "Rip.45IncRip+Spade.30" ~ "IncRip+Spade",
    soil_modification_depth == "Rip.60IncRip+Spade.30" ~ "IncRip+Spade",
    
    soil_modification_depth == "Rip.30IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.40IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.45IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.50IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.60IncRip" ~           "IncRip",
    
    
    TRUE ~ "NA"
  ))






#2 all soil modification without depth (if 2 soil modification used keep this)	

summary_control_data_all <- summary_control_data_all %>% 
  mutate(soil_modification = case_when(
    soil_modification_2 == "NA" ~ soil_modification_1,
    TRUE ~ soil_modification_2
  ))


### remove the working clms
summary_control_data_all <- summary_control_data_all %>% 
  select(-soil_modification_1,
         -soil_modification_2)


#how many modification without depth
soil_modification_depth <- summary_control_data_all %>% 
  distinct(soil_modification) %>% 
  arrange(soil_modification) %>% 
  filter(soil_modification != "Unmodified")

count(soil_modification_depth) #8 excluding the unmodified 



#####################################################################################
#####  soil amendments      #####
#####################################################################################
back_up <- summary_control_data_all
### get the soil Amendment from the Descriptors
# gets all the amendments
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_all = sub("^[^_]*_", "", summary_control_data_all$Descriptors)) #keep everything after the first _
#pull out the first amendment listed but has rates
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_1 = str_extract(summary_control_data_all$amendment_all, "[^.]+"))#keep everything before the first 
#removed the rates in the first amendment listed 
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_1 = str_extract(summary_control_data_all$amendment_1, "[^@]+")) #keep everything before the first @

#temp <- summary_control_data_all %>%  distinct(amendment_1) %>% arrange(amendment_1)


#pull out the second amendment listed but has rates (_/.)
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_2a = sub("^[^.]*.", "", summary_control_data_all$amendment_all)) 
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_2b = sub("^[^.]*.", "", summary_control_data_all$amendment_2a)) 
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_2 = str_extract(summary_control_data_all$amendment_2b, "[^.]+"))

#temp <- summary_control_data_all %>%  distinct(amendment_2) %>% arrange(amendment_2)



### not quite right remove some problems!
unique(summary_control_data_all$amendment_2)

summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_2 = case_when(
    amendment_2 ==  "surface_Yr18,19,20" ~ "",
    amendment_2 ==  "incorp_50" ~ "",
    amendment_2 ==  "band_30" ~ "",
    amendment_2 ==  "band_50" ~ "",
    amendment_2 ==  "surface" ~ "",
    
    TRUE ~ amendment_2
  ))
unique(summary_control_data_all$amendment_2)



#pull out the thrid amendment listed but has rates (_/.)
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_3a = sub("^[^.]*.", "", summary_control_data_all$amendment_2b)) 
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_3b = sub("^[^.]*.", "", summary_control_data_all$amendment_3a)) 
summary_control_data_all <- summary_control_data_all %>% 
  mutate(amendment_3 = str_extract(summary_control_data_all$amendment_3b, "[^.]+"))


temp <- summary_control_data_all %>%  distinct(amendment_3) %>% arrange(amendment_3)


### bugger the timing year for amenedment 2 is stuffed up!
unique(summary_control_data_all$amendment_1)
unique(summary_control_data_all$amendment_2)
unique(summary_control_data_all$amendment_3)



## amendments 1, 2, 3 together.
str(summary_control_data_all)


summary_control_data_all$amendment_1 <-  
  stringr::str_replace_na(summary_control_data_all$amendment_1 , replacement='')

summary_control_data_all$amendment_2 <-  
  stringr::str_replace_na(summary_control_data_all$amendment_2 , replacement='')  

summary_control_data_all$amendment_3 <-  
  stringr::str_replace_na(summary_control_data_all$amendment_3 , replacement='')


summary_control_data_all <-  summary_control_data_all %>% 
  mutate(amendment_123 = paste0(amendment_1,
                                amendment_2,
                                amendment_3))


#tidy up working outs
summary_control_data_all <- summary_control_data_all %>%
  select(-amendment_2a, -amendment_2b, -amendment_3a, -amendment_3b)

unique(summary_control_data_all$amendment_123)
#how many amendment without depth
amendment_no_depth <- summary_control_data_all %>%
  distinct(amendment_123) %>%
  arrange(amendment_123) %>%
  filter(amendment_123 != "none")

count(amendment_no_depth) #28 excluding the none
```

```{r working out how many modification all, echo=FALSE, message=FALSE, warning=FALSE}
## how many different modification?

#summary_control_data_all


#how many modification_depth
soil_modification_depth <- summary_control_data_all %>% 
  distinct(soil_modification_depth) %>% 
  arrange(soil_modification_depth) %>% 
  filter(soil_modification_depth != "Unmodified")
  
count(soil_modification_depth) #21 excluding the unmodified

```


How many soil amendment (including different depths)?

```{r how many amendment all, echo=FALSE, message=FALSE, warning=FALSE}

amendment_depth <- summary_control_data_all %>% 
  distinct(amendment_all) %>% 
  arrange(amendment_all) %>% 
  filter(amendment_all != "none")
  
count(amendment_depth) #91 excluding the unmodified



```


Add code for amedments classed as

animal

plant

non organic

none

mixed

```{r code for amendment plant and animals, message=FALSE, warning=FALSE, include=FALSE}

summary_control_data_all<- summary_control_data_all %>% 
  mutate(amendment_code1 = case_when(
    amendment_123 ==  "none" ~ "none",
    
    amendment_123 ==  "Cl" ~ "animal",
    
    amendment_123 ==  "Lc" ~ "plant",
    amendment_123 ==  "Cereal" ~ "plant",
    amendment_123 ==  "Vetch" ~ "plant",
    amendment_123 ==  "Vet_Cer" ~ "plant",
    amendment_123 ==  "Vet_Cer_In" ~ "plant", 
    amendment_123 ==  "Com" ~ "plant",
    
    amendment_123 ==  "Fert" ~       "fertiliser",
    amendment_123 ==  "Fert_High" ~ "fertiliser",
    amendment_123 ==  "Fert_Low" ~ "fertiliser",
    amendment_123 ==  "Fert_APP" ~ "fertiliser",
    amendment_123 ==  "K_added" ~ "fertiliser",
    amendment_123 ==  "FertK_added" ~ "fertiliser",
    
    
    amendment_123 ==  "Gypsum" ~ "non organic",
    amendment_123 ==  "Clay" ~ "non organic",
    amendment_123 ==  "Lime" ~ "non organic",
    amendment_123 ==  "Bi_Agra" ~ "non organic",
    amendment_123 ==  "SE14" ~ "non organic",
    
    
    amendment_123 ==  "ClFertClay" ~ "mixed",
    amendment_123 ==  "ClFert" ~ "mixed",
    amendment_123 ==  "ClClay" ~ "mixed",
    amendment_123 ==  "ClLime" ~ "mixed",
    amendment_123 ==  "ClGypsum" ~ "mixed",
    
    amendment_123 ==  "LcFert" ~ "mixed",
    amendment_123 ==  "LcClay" ~ "mixed",
    amendment_123 ==  "LcFertClay" ~ "mixed",
    amendment_123 ==  "LcK_added" ~ "mixed",
    
    amendment_123 ==  "FertClay" ~ "mixed",
    
    
    TRUE ~ "check"
    
    
  ))
  
```



## Scatter Plots



```{r plot all, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = summary_control_data_all, mapping = aes(control_yield, yield,)) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  geom_point(alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE) +
  scale_x_continuous(breaks=seq(0,10,by=0.5))+
  scale_y_continuous(breaks=seq(0,10,by=0.5))+
  theme_bw()+
  labs(title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")
```

```{r scatter plot all, eval=FALSE, message=TRUE, warning=FALSE, include=FALSE}

# every trial yield point that has a matching control yld is displayed

scatter_control_vs_trial <- ggplot(data = summary_control_data_all, mapping = aes(control_yield, yield,)) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  geom_point(alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")

scatter_control_vs_trial

ggplotly(scatter_control_vs_trial)


```

## Scatter Plots with Facet wrap is years post amelioration, the NA related to trial with no metadata

Missing year trial start date for;


Kooloong Canola (missing I need to check what I have)

Ouygen Sapde (missing)

```{r scatter plot all facet years post, echo=FALSE, message=FALSE, warning=FALSE}


ggplot(data = summary_control_data_all, mapping = aes(control_yield, yield,)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  # scale_x_continuous(breaks=seq(0,10,by=0.5))+
  # scale_y_continuous(breaks=seq(0,10,by=0.5))+
  theme_bw()+
  labs(title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control
       \nFacet wrap is years post amelioration, the NA related to trial with no metdata",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ yr_post_amelioration)


```


## Scatter Plots with Facet wrap is sites


```{r scatter plot all facet sub site post, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data = summary_control_data_all, mapping = aes(control_yield, yield,)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  # scale_x_continuous(breaks=seq(0,10,by=0.5))+
  # scale_y_continuous(breaks=seq(0,10,by=0.5))+
  theme_bw()+
  labs(title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control
       \nFacet wrap is sites",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ site_sub)

```

## Scatter Plots with Facet wrap is modification

This modification still includes everything all trials that had a modification and may amendment eg include clay fertilsier etc.

The unmodified exists because the trials might still have amendment.

Note for Jackie - the below code will need to be updated when all the sites are included and if names change.




How many soil modification (with NO depth differences eg all the ripping is included in rip)?

```{r how many NO depth modification all, echo=FALSE, message=FALSE, warning=FALSE}

#how many modification_depth
soil_modification_NO_depth <- summary_control_data_all %>% 
  distinct(soil_modification) %>% 
  arrange(soil_modification) %>% 
  filter(soil_modification != "Unmodified")
  
count(soil_modification_NO_depth) #8 excluding the unmodified

  
```  
  

```{r scatter modification, echo=FALSE, message=FALSE, warning=FALSE}



summary_control_data_all %>%  
  filter(soil_modification != "Unmodified") %>% 
ggplot( mapping = aes(control_yield, yield,)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  #scale_x_continuous(breaks=seq(0,10,by=0.5))+
  #scale_y_continuous(breaks=seq(0,10,by=0.5))+
  theme_bw()+
  labs(#title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control
       #\nFacet wrap is modification",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ soil_modification)


```


## subset data so there is no amendment

```{r subset data, message=FALSE, warning=FALSE, include=FALSE}
### subset data so we have no amendment
str(summary_control_data_all)
unique(summary_control_data_all$amendment_all)
no_amendment <- summary_control_data_all %>% 
  filter(amendment_all ==  "none"  )
str(no_amendment)
unique(summary_control_data_all$soil_modification)

## change the order of the modification
order_modification <- c("Rip",
                        "Rip+Spade", 
                        "Spade", 
                        "Sweep" , 
                        "Inc" ,
                        "IncRip" ,
                        "IncRip+Spade",
                        #"Delving",
                        "DiscInv",
                        "Unmodified" )
no_amendment$soil_modification <- factor(no_amendment$soil_modification,
                                         levels = order_modification)
```

## Scatter Plots with subset data

```{r scatter subset data, echo=FALSE, message=FALSE, warning=FALSE}
### control vs trials
ggplot(data = no_amendment, mapping = aes(control_yield, yield)) +
  geom_point(aes(colour= soil_modification),alpha= 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
  geom_smooth(data = no_amendment, method = lm, se = FALSE, colour = "black", size = 0.5) +
  scale_x_continuous(breaks=seq(0,10,by=0.5))+
  scale_y_continuous(breaks=seq(0,10,by=0.5))+
  theme_bw()+
  labs(title = "Control yield - subset of data no amendment",
       subtitle = "note each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")



```




## Scatter Plots with subset data
### Facet wrap is years post amelioration, the NA related to trial with no metdata
```{r scatter subset data facet yrs post, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = no_amendment, mapping = aes(control_yield, yield)) +
  geom_point(aes(colour= soil_modification),alpha= 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
  #geom_smooth(data = no_amendment, method = lm, se = FALSE, colour = "black", size = 0.5) +
  labs(title = "Control yield - subset of data no amendment",
       subtitle = "note each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ as.factor(yr_post_amelioration))

```





## Scatter Plots with subset data
### Facet wrap is sites

```{r scatter subset data facet site, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = no_amendment, mapping = aes(control_yield, yield)) +
  geom_point(aes(colour= soil_modification),alpha= 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
  geom_smooth(data = no_amendment, method = lm, se = FALSE, colour = "black", size = 0.5) +
  labs(title = "Control yield - subset of data no amendment",
       subtitle = "note each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ site_sub)
```

## Scatter Plots with subset data
### Facet wrap is modification


```{r scatter subset data facet modification, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = no_amendment, mapping = aes(control_yield, yield)) +
  geom_point(aes(colour= soil_modification),alpha= 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
  geom_smooth(data = no_amendment, method = lm, se = FALSE, colour = "black", size = 0.5) +
  labs(title = "Control yield - subset of data no amendment",
       subtitle = "note each site, treatment, year and rep is matched to control",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ soil_modification)

### same as above but with unmodified removed and title removed for TB 
# no_amendment %>%  filter(soil_modification != "Unmodified") %>% 
#   ggplot(mapping = aes(control_yield, yield)) +
#   geom_point(aes(colour= soil_modification),alpha= 0.4) +
#   geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
#   geom_smooth(data = no_amendment %>%  filter(soil_modification != "Unmodified"), 
#               method = lm, se = FALSE, colour = "black", size = 0.5) +
#   labs(#title = "Control yield - subset of data no amendment",
#        #subtitle = "note each site, treatment, year and rep is matched to control",
#        x = "control yield t/ha", y = "trial yield t/ha")+
#   facet_wrap(.~ soil_modification)


```



# Yield Gains
## Histograms Plots


```{r yld gains cals, message=FALSE, warning=FALSE, include=FALSE}
#### Yld gain #####

#### need to make a yield gain clm first
summary_control_data_all <- summary_control_data_all %>% 
  mutate(yield_gain = yield-control_yield, na.rm = TRUE)


## cal the mean yield gains for modification
mean_values <- summary_control_data_all %>% 
  group_by(soil_modification) %>% 
  summarise(mod_mean = mean(yield_gain,  na.rm = TRUE))

```

```{r yld gains histograms, echo=FALSE, message=FALSE, warning=FALSE}
mean_value <- mean(summary_control_data_all$yield_gain, na.rm = TRUE)
mean_value <- round(mean_value, 2)

ggplot(summary_control_data_all, aes(yield_gain)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), colour = 1, fill = "white") +
  geom_vline(data = summary_control_data_all, aes(xintercept=mean(yield_gain,  na.rm = TRUE)), color="blue", linetype="dashed", size=1)+
    geom_vline(data = summary_control_data_all, aes(xintercept=0), color="black", linetype="dashed", size=1)+
  labs(title = "Yield gains - all data - no summary\nNote each site, treatment, year and rep is matched to control\nBlue line is mean yield gain",
       subtitle = paste0("Mean yield gain ", mean_value, "t/ha"),
       x = "yield gain t/ha", y = "frequency of occurrence")
  
```

## Histograms Plots
### Facet wrap is modification

```{r yld gains histograms facet wraps modification, echo=FALSE, message=FALSE, warning=FALSE}
  
# Histogram for each modification with mean yield gain plotted
ggplot(summary_control_data_all, aes(x = yield_gain)) + 
  # geom_histogram(aes(y = ..density..),colour = 1, fill = "white") +
  geom_histogram(aes(y = (..count..)/sum(..count..)), group = 1, colour = 1, fill = "white") +
  geom_vline(data = mean_values, aes(xintercept=mod_mean),       color="blue", linetype="dashed", size=1)+
  geom_vline(data = summary_control_data_all, aes(xintercept=0), color="black", linetype="dashed", size=1)+
  facet_wrap(.~ soil_modification)+
  labs(title = "Yield gains - all data - no summary\nNote each site, treatment, year and rep is matched to control
         \nFacet wrap is modification\nBlue line is mean yield gain",
       x = "yield gain t/ha", y = "frequency of occurrence")
```



## Histograms Plots with subset of data 
### Subset data so there is no amendment


```{r yld gains cals subset, echo=FALSE, message=FALSE, warning=FALSE}

#### need to make a yield gain clm first
no_amendment <- no_amendment %>% 
  mutate(yield_gain = yield-control_yield, na.rm = TRUE)

## cal the mean yield gains for modification
mean_values_no_amendment <- no_amendment %>% 
  group_by(soil_modification) %>% 
  summarise(mod_mean = mean(yield_gain,  na.rm = TRUE))

```

```{r yld gains histograms subset, echo=FALSE, message=FALSE, warning=FALSE}
mean_value_no_amend <- mean(no_amendment$yield_gain, na.rm = TRUE)
mean_value_no_amend <- round(mean_value_no_amend, 2)


ggplot(no_amendment, aes(yield_gain)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), colour = 1, fill = "white") +
  geom_vline(data = no_amendment, aes(xintercept=mean(yield_gain,  na.rm = TRUE)), color="blue", linetype="dashed", size=1)+
  geom_vline(data = no_amendment, aes(xintercept=0), color="black", linetype="dashed", size=1)+
  
  labs(title = "Yield gains - subset of data no amendment\nNote each site, treatment, year and rep is matched to control\nBlue line is mean yield gain",
       subtitle = paste0("Mean yield gain ", mean_value_no_amend, "t/ha"),
       x = "yield gain t/ha", y = "frequency of occurrence")
```

## Histograms Plots with subset of data
### Facet wrap is modification



```{r yld gains histograms subset facet wraps modification, echo=FALSE, message=FALSE, warning=FALSE}

# Histogram for each modification with mean yield gain plotted
ggplot(no_amendment, aes(yield_gain)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), colour = 1, fill = "white") +
  geom_vline(data = mean_values_no_amendment, aes(xintercept=mod_mean), color="blue", linetype="dashed", size=1)+
  geom_vline(data = no_amendment, aes(xintercept=0), color="black", linetype="dashed", size=1)+
  labs(title = "Yield gains - subset of data no amendment",
       subtitle = "Note each site, treatment, year and rep is matched to control\nBlue line is mean yield gain",
       x = "yield gain t/ha", y = "frequency of occurrence")+
  facet_wrap(.~ soil_modification)
```


#  Cumulative yields   


```{r cum yld cals, message=FALSE, warning=FALSE, include=FALSE}

#keep the rep but not the year
cum_yld_control <- summary_control_data_all %>% 
  dplyr::group_by(site_sub, Descriptors,rep_block ) %>% 
  dplyr::summarise(sum_yld = sum(yield, na.rm = TRUE),
            sum__control_yld = sum(control_yield, na.rm = TRUE),
            max_yr_post_amelioration = max(yr_post_amelioration  , na.rm = TRUE),
            check_yld_value = (sum_yld/max_yr_post_amelioration),
            check_yld_control_value = (sum__control_yld/max_yr_post_amelioration))


cum_yld_control <- cum_yld_control %>% 
  mutate(`length of trial` = as.factor(max_yr_post_amelioration))
```

### Scatter plots

Note I have done a check on some of these high values.
The high cumulative control is for Yenda and this averaged to approx. 5.6 t/ha
The other high values are from Bute CSIRO with average per yr at 5 t/ha

So this seems OK.

```{r cum yld scatter, echo=FALSE, message=FALSE, warning=FALSE}
scatter_control_vs_trial_cum_yld <- 
  ggplot(data = cum_yld_control, mapping = aes(sum__control_yld, sum_yld, )) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "Cumulative control yield - all data - no summary\nnote that for each site, treatment and rep all yield is summed over all years\nand it is matched to summed control
      \nBlack line is 1:1, blue is regression line",
       x = "cumulative control yield t/ha", y = "cumulative trial yield t/ha")+
  geom_abline(intercept = 0, slope = 1, linetype="dashed")

scatter_control_vs_trial_cum_yld
```

### Scatter plots with trial length

```{r cum yld scatter with lenghth , echo=FALSE, message=FALSE, warning=FALSE}
scatter_control_vs_trial_cum_yld_trial_lenghth <- 
  ggplot(data = cum_yld_control, mapping = aes(sum__control_yld, sum_yld, colour = `length of trial`)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  labs(title = "Cumulative control yield - all data - no summary",
       subtitle ="note that for each site, treatment and rep yields are summed over multiple years\nand it is matched to summed control yield",
       x = "cumulative control yield t/ha", y = "cumulative trial yield t/ha")
scatter_control_vs_trial_cum_yld_trial_lenghth
```







# Cumulative yields for yield gains  

```{r cum yld gains cal, message=FALSE, warning=FALSE, include=FALSE}
str(summary_control_data_all)
#keep the rep but not the year
cum_yld_gains_control <- summary_control_data_all %>% 
  group_by(site_sub, Descriptors,rep_block ) %>% 
  summarise(sum_yld_gains = sum(yield_gain, na.rm = TRUE),
            max_yr_post_amelioration = max(yr_post_amelioration  , na.rm = TRUE))
cum_yld_gains_control

cum_yld_gains_control <- ungroup(cum_yld_gains_control)



#####################################################################################
#####  soil modifications      #####
#####################################################################################
# summary_control_data_all <- summary_control_data_all %>%
#   distinct(site, Descriptors, .keep_all=TRUE) %>%
#   select(site,
#          Descriptors )
# summary_control_data_all <- summary_control_data_all %>% arrange(site,Descriptors )

### get the soil modification from the Descriptors

#1 soil modification with depth
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_depth =  str_extract(cum_yld_gains_control$Descriptors, "[^_]+"))#keep everything before the first_

#1.1 Youndhusband has 'Unmodified+DeepTill.18' which needs to be recoded as "Unmodified"

cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_depth = case_when(
    soil_modification_depth == "Unmodified+DeepTill.18" ~ "Unmodified",
    TRUE ~ soil_modification_depth))




#how many modification_depth
soil_modification_depth <- cum_yld_gains_control %>% 
  distinct(soil_modification_depth) %>% 
  arrange(soil_modification_depth) %>% 
  filter(soil_modification_depth != "Unmodified")

count(soil_modification_depth) #20 excluding the unmodified


#1a working clms - soil modification without depth 1 only
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_1 =  str_extract(cum_yld_gains_control$Descriptors, "[^.]+"))#keep everything before the first .

#the Unmodified seems to have a problem this fixes it :)
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_1 = str_extract(cum_yld_gains_control$soil_modification_1, "[^_]+")) #keep everything after the first _

#1a.1 Youndhusband has 'Unmodified+DeepTill.18' which needs to be recoded as "Unmodified"

cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_1 = case_when(
    soil_modification_1 == "Unmodified+DeepTill" ~ "Unmodified",
    TRUE ~ soil_modification_1))

cum_yld_gains_control %>%  distinct(soil_modification_1) %>% arrange(soil_modification_1)



#1a working clms - 2 soil modification without depth 2
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification_2 = case_when(
    soil_modification_depth == "Rip.50Spade.30" ~        "Rip+Spade",
    soil_modification_depth == "Rip.60Spade.30" ~        "Rip+Spade",
    soil_modification_depth == "Rip.45IncRip+Spade.30" ~ "IncRip+Spade",
    soil_modification_depth == "Rip.60IncRip+Spade.30" ~ "IncRip+Spade",
    
    soil_modification_depth == "Rip.30IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.40IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.45IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.50IncRip" ~           "IncRip",
    soil_modification_depth == "Rip.60IncRip" ~           "IncRip",
    
    
    TRUE ~ "NA"
  ))




#2 all soil modification without depth (if 2 soil modification used keep this)	

cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(soil_modification = case_when(
    soil_modification_2 == "NA" ~ soil_modification_1,
    TRUE ~ soil_modification_2
  ))


### remove the working clms
cum_yld_gains_control <- cum_yld_gains_control %>% 
  select(-soil_modification_1,
         -soil_modification_2)


#how many modification without depth
soil_modification_depth <- cum_yld_gains_control %>% 
  distinct(soil_modification) %>% 
  arrange(soil_modification) %>% 
  filter(soil_modification != "Unmodified")

count(soil_modification_depth) #8 excluding the unmodified 



#####################################################################################
#####  soil amendments      #####
#####################################################################################
back_up <- cum_yld_gains_control
### get the soil Amendment from the Descriptors
# gets all the amendments
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_all = sub("^[^_]*_", "", cum_yld_gains_control$Descriptors)) #keep everything after the first _
#pull out the first amendment listed but has rates
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_1 = str_extract(cum_yld_gains_control$amendment_all, "[^.]+"))#keep everything before the first 
#removed the rates in the first amendment listed 
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_1 = str_extract(cum_yld_gains_control$amendment_1, "[^@]+")) #keep everything before the first @


#pull out the second amendment listed but has rates (_/.)
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_2a = sub("^[^.]*.", "", cum_yld_gains_control$amendment_all)) 
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_2b = sub("^[^.]*.", "", cum_yld_gains_control$amendment_2a)) 
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_2 = str_extract(cum_yld_gains_control$amendment_2b, "[^.]+"))

### not quite right remove some problems!
unique(cum_yld_gains_control$amendment_2)

cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_2 = case_when(
    amendment_2 ==  "surface_Yr18,19,20" ~ "",
    amendment_2 ==  "incorp_50" ~ "",
    amendment_2 ==  "band_30" ~ "",
    amendment_2 ==  "band_50" ~ "",
    amendment_2 ==  "surface" ~ "",
    TRUE ~ amendment_2
  ))
unique(cum_yld_gains_control$amendment_2)



#pull out the thrid amendment listed but has rates (_/.)
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_3a = sub("^[^.]*.", "", cum_yld_gains_control$amendment_2b)) 
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_3b = sub("^[^.]*.", "", cum_yld_gains_control$amendment_3a)) 
cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(amendment_3 = str_extract(cum_yld_gains_control$amendment_3b, "[^.]+"))





### bugger the timing year for amenedment 2 is stuffed up!
unique(cum_yld_gains_control$amendment_1)
unique(cum_yld_gains_control$amendment_2)
unique(cum_yld_gains_control$amendment_3)



## amendments 1, 2, 3 together.
str(cum_yld_gains_control)


cum_yld_gains_control$amendment_1 <-  
  stringr::str_replace_na(cum_yld_gains_control$amendment_1 , replacement='')

cum_yld_gains_control$amendment_2 <-  
  stringr::str_replace_na(cum_yld_gains_control$amendment_2 , replacement='')  

cum_yld_gains_control$amendment_3 <-  
  stringr::str_replace_na(cum_yld_gains_control$amendment_3 , replacement='')


cum_yld_gains_control <-  cum_yld_gains_control %>% 
  mutate(amendment_123 = paste0(amendment_1,
                                amendment_2,
                                amendment_3))


#tidy up working outs
cum_yld_gains_control <- cum_yld_gains_control %>%
  select(-amendment_2a, -amendment_2b, -amendment_3a, -amendment_3b)

unique(cum_yld_gains_control$amendment_123)
#how many amendment without depth
amendment_no_depth <- cum_yld_gains_control %>% 
  distinct(amendment_123) %>% 
  arrange(amendment_123) %>% 
  filter(amendment_123 != "none")

count(amendment_no_depth) #26 excluding the none 














############################################################################


## cal the mean yield gains for modification
mean_gains_values <- cum_yld_gains_control %>% 
  group_by(soil_modification) %>% 
  summarise(mod_mean_gains = mean(sum_yld_gains,  na.rm = TRUE))

cum_yld_gains_control <- cum_yld_gains_control %>% 
  mutate(`length of trial` = as.factor(max_yr_post_amelioration))

```


### Histograms plot

```{r cum yld gains histogram 1, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(cum_yld_gains_control, aes(sum_yld_gains)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), colour = 1, fill = "white") +
  geom_vline(data = cum_yld_gains_control, aes(xintercept=mean(sum_yld_gains,  na.rm = TRUE)), color="blue", linetype="dashed", size=1)+
  geom_vline(data = cum_yld_gains_control, aes(xintercept=0), color="black", linetype="dashed", size=1)+
  labs(title = "Cumulative control yield - all data - no summary",
       subtitle ="note that for each site, treatment and rep yields are summed over multiple years\nand it is matched to summed control yield",
       x = "cumulative yield gain t/ha", y = "frequency of occurrence")

```


### Histograms plot for spading and ripping only


```{r cum yld gains histogram, echo=FALSE, message=FALSE, warning=FALSE}

# Histogram for each modification with mean yield gain plotted


cum_yld_gains_control %>% 
  filter(soil_modification =="Spade"| soil_modification == "Rip") %>% 
 ggplot( aes(x = sum_yld_gains)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), group = 1, colour = 1, fill = "white") +
  geom_vline(data = mean_gains_values %>% 
               filter(soil_modification =="Spade"| soil_modification == "Rip"), aes(xintercept=mod_mean_gains),       color="blue", linetype="dashed", size=1)+
  geom_vline(data = cum_yld_gains_control%>% 
               filter(soil_modification =="Spade"| soil_modification == "Rip"), aes(xintercept=0), color="black", linetype="dashed", size=1)+
  facet_wrap(.~ soil_modification)+
  labs(title = "Cumulative control yield",
       subtitle ="note that for each site, treatment and rep yields are summed over multiple years\nand it is matched to summed control yield",
       x = "cumulative yield gain t/ha", y = "frequency of occurrence")


```

# Cummulative yields for yeild gains with no amedments 


```{r cum yld gains no amedments cals, message=FALSE, warning=FALSE, include=FALSE}
#keep the rep but not the year
cum_yld_no_amendment <- no_amendment %>% 
  group_by(site_sub, Descriptors,soil_modification,rep_block ) %>% 
  summarise(sum_yld = sum(yield, na.rm = TRUE),
            sum__control_yld = sum(control_yield, na.rm = TRUE),
            max_yr_post_amelioration = max(yr_post_amelioration  , na.rm = TRUE))
cum_yld_no_amendment

cum_yld_no_amendment <- cum_yld_no_amendment %>% 
  mutate(`length of trial` = as.factor(max_yr_post_amelioration))

```

### Scatter plots

```{r cum yld gains no amedments scatter, message=FALSE, warning=FALSE, include=FALSE}
  ggplot(data = cum_yld_no_amendment, mapping = aes(sum__control_yld, sum_yld, )) +
    geom_point(aes(colour= soil_modification),alpha= 0.4) +
    geom_abline(intercept = 0, slope = 1, linetype="dashed", size = 0.5)+
    geom_smooth(data = cum_yld_no_amendment, method = lm, se = FALSE, colour = "black", size = 0.5) +
      labs(title = "Cumulative control yield - subset of data no amendment",
         subtitle = "note that for each site, treatment and rep all yield is summed over all years\nand it is matched to summed control
         \nBlack dashed is 1:1, solid line is regression line",
         x = "control yield t/ha", y = "trial yield t/ha")+
  geom_abline(intercept = 0, slope = 1, linetype="dashed")

```

### Histograms

```{r cum yld gains no amedments cal mean, message=FALSE, warning=FALSE, include=FALSE}
  
  ## cal the mean yield gains for modification
  mean_gains_values_no_amendment <- cum_yld_no_amendment %>% 
    group_by(soil_modification) %>% 
    summarise(mod_mean_gains = mean(sum_yld,  na.rm = TRUE))
  
``` 
  
 
```{r cum yld gains no amedments hist, echo=FALSE, message=FALSE, warning=FALSE}
 
  cum_yld_no_amendment %>% 
    ggplot( aes(x = sum_yld)) + 
    geom_histogram(aes(y = (..count..)/sum(..count..)), group = 1, colour = 1, fill = "white") +
    
    geom_vline(data = mean_gains_values_no_amendment, 
               aes(xintercept=mod_mean_gains),       color="blue", linetype="dashed", size=1)+
    
    geom_vline(data = cum_yld_no_amendment, 
               aes(xintercept=0), color="black", linetype="dashed", size=1)+
    facet_wrap(.~ soil_modification)+
    labs(title = "Cumulative control yield - subset of data no amendment",
         subtitle ="note that for each site, treatment and rep yields are summed over multiple years\nand it is matched to summed control yield",
         x = "cumulative yield gain t/ha", y = "frequency of occurance")
  
```


### Histograms just the ripping and spading
```{r cum yld gains no amedments hist spad and rip, echo=FALSE, message=FALSE, warning=FALSE}
 
mean_gains_values_no_amendment_Rip <- mean_gains_values_no_amendment %>% 
  dplyr::filter(soil_modification == "Rip")
mean_gains_values_no_amendment_Rip <- round(mean_gains_values_no_amendment_Rip[1,2],2)

mean_gains_values_no_amendment_spade <- mean_gains_values_no_amendment %>% 
  dplyr::filter(soil_modification == "Spade")
mean_gains_values_no_amendment_spade <- round(mean_gains_values_no_amendment_spade[1,2],2)


cum_yld_no_amendment %>% 
  filter(soil_modification =="Spade"| soil_modification == "Rip") %>% 
  ggplot( aes(x = sum_yld)) + 
  geom_histogram(aes(y = (..count..)/sum(..count..)), group = 1, colour = 1, fill = "white") +
  
  geom_vline(data = mean_gains_values_no_amendment%>% 
               filter(soil_modification =="Spade"| soil_modification == "Rip"), 
             aes(xintercept=mod_mean_gains),       color="blue", linetype="dashed", size=1)+
  
  geom_vline(data = cum_yld_no_amendment %>% 
               filter(soil_modification =="Spade"| soil_modification == "Rip"), 
             aes(xintercept=0), color="black", linetype="dashed", size=1)+
  facet_wrap(.~ soil_modification)+
  labs(title = "Cumulative control yield - subset of data no amendment",
       subtitle ="note that for each site, treatment and rep yields are summed over multiple years\nand it is matched to summed control yield",
       caption = paste0("Mean cumulative yield gain, Rip: ", 
                        mean_gains_values_no_amendment_Rip,
                        " Spade: ",mean_gains_values_no_amendment_spade),
       x = "cumulative yield gain t/ha", y = "frequency of occurance")
```


#  Amendment groupings







```{r scatter amendment, echo=FALSE, message=FALSE, warning=FALSE}

summary_control_data_amendment_code1 <- summary_control_data_all %>%  
  filter(amendment_code1 != "none") %>%  
  filter(amendment_code1 != "non organic") %>% 
  filter(amendment_code1 != "mixed" ) 

#unique(summary_control_data_amendment_code1$amendment_code1)

summary_control_data_amendment_code1$amendment_code1 <-
  factor(summary_control_data_amendment_code1$amendment_code1,
         levels = c("animal", "plant", "fertiliser"))


 summary_control_data_amendment_code1 %>%  
  filter(!is.na(yield)) %>% 
  filter(!is.na(control_yield)) %>% 
  
  ggplot( mapping = aes(control_yield, yield)) +
  geom_point(aes(colour= amendment_code1),alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE, na.rm = TRUE) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")),
    formula = (y ~ x)
  ) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Control yield - all data - no summary\nnote each site, treatment, year and rep is matched to control
    \nFacet wrap is filtered data amendments",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ amendment_code1)

    





```


what about when no soil modification was made?

```{r scatter amendment but no soil modification, echo=FALSE, message=FALSE, warning=FALSE}
summary_control_data_amendment_code1 %>% 
  filter(!is.na(yield)) %>% 
  filter(!is.na(control_yield)) %>% 
  filter(soil_modification == "Unmodified") %>% 
  
  ggplot( mapping = aes(control_yield, yield,)) +
  geom_point(aes(colour= amendment_code1),alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")),
    formula = (y ~ x)
  ) +
  
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Control yield - no summary. BUT no soil modification \nnote each site, treatment, year and rep is matched to control
      \nFacet wrap is amendment",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ amendment_code1)
```


what about when ANY soil modification was made?

```{r scatter amendment but ANY soil modification, echo=FALSE, message=FALSE, warning=FALSE}
summary_control_data_amendment_code1 %>% 
  filter(soil_modification != "Unmodified") %>% 
  filter(!is.na(yield)) %>% 
  filter(!is.na(control_yield)) %>% 
  
  ggplot( mapping = aes(control_yield, yield,)) +
  geom_point(aes(colour= amendment_code1),alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")),
    formula = (y ~ x)
  ) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Control yield - no summary. ANY soil modification \nnote each site, treatment, year and rep is matched to control
      \nFacet wrap is amendment",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ amendment_code1)


```


Just Ripping

```{r scatter amendment but ripping only, echo=FALSE, message=FALSE, warning=FALSE}
summary_control_data_amendment_code1 %>% 
  filter(soil_modification == "Rip") %>% 
  filter(!is.na(yield)) %>% 
  filter(!is.na(control_yield)) %>% 
  
  ggplot( mapping = aes(control_yield, yield,)) +
  geom_point(aes(colour= amendment_code1),alpha= 0.4) +
  geom_smooth(method = lm, se = FALSE) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~")),
    formula = (y ~ x)
  ) +
  geom_abline(intercept = 0, slope = 1, linetype="dashed")+
  
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Control yield - no summary. Ripping only \nnote each site, treatment, year and rep is matched to control
      \nFacet wrap is amendment",
       x = "control yield t/ha", y = "trial yield t/ha")+
  facet_wrap(.~ amendment_code1)


```